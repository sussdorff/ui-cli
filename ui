#!/usr/bin/env bash
# UniFi CLI wrapper script
# Automatically activates virtual environment and runs the CLI

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
CONDA_ENV="ui-cli"

# Load config from standard locations (first found wins)
# Priority: XDG config > home dotfile > project .env
load_config() {
    local config_files=(
        "${XDG_CONFIG_HOME:-$HOME/.config}/ui-cli/config"
        "$HOME/.ui-cli.env"
        "$SCRIPT_DIR/.env"
    )

    for config in "${config_files[@]}"; do
        if [ -f "$config" ]; then
            set -a
            source "$config"
            set +a
            return 0
        fi
    done
}

load_config

# Try venv/pip first, then conda
if [ -f "$SCRIPT_DIR/.venv/bin/activate" ]; then
    source "$SCRIPT_DIR/.venv/bin/activate"
elif [ -f "$SCRIPT_DIR/venv/bin/activate" ]; then
    source "$SCRIPT_DIR/venv/bin/activate"
else
    # Conda fallback
    if [ -f "$HOME/miniconda3/etc/profile.d/conda.sh" ]; then
        source "$HOME/miniconda3/etc/profile.d/conda.sh"
    elif [ -f "$HOME/anaconda3/etc/profile.d/conda.sh" ]; then
        source "$HOME/anaconda3/etc/profile.d/conda.sh"
    elif [ -f "/opt/homebrew/Caskroom/miniconda/base/etc/profile.d/conda.sh" ]; then
        source "/opt/homebrew/Caskroom/miniconda/base/etc/profile.d/conda.sh"
    elif [ -f "/usr/local/Caskroom/miniconda/base/etc/profile.d/conda.sh" ]; then
        source "/usr/local/Caskroom/miniconda/base/etc/profile.d/conda.sh"
    elif [ -n "$CONDA_EXE" ]; then
        source "$(dirname "$CONDA_EXE")/../etc/profile.d/conda.sh"
    fi

    conda activate "$CONDA_ENV" 2>/dev/null || {
        echo "Error: No Python environment found."
        echo "Options:"
        echo "  1. pip:   python -m venv .venv && source .venv/bin/activate && pip install -e ."
        echo "  2. conda: conda env create -f environment.yml"
        exit 1
    }
fi

# Run the CLI
python -m ui_cli.main "$@"
